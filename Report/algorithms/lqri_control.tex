%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%	PSEUDOCODE -- LQRI control
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{algorithm}
\caption{LQRI control}\label{alg:lqri}
\begin{algorithmic}[0]

\Procedure{getLQRIController}{$A,B,H,Q,R,Ts$}
\State $A,B\gets \Call{discretizeSystem}{A,B,Ts}$
\State $K\gets \Call{lqi}{A,B,H,Q,R}$
\State \Return $K$
\EndProcedure

\Procedure{callLQRIController}{$x,r,e,K,\psi$}
\State $x \gets \Call{transformWorld2Orientation}{x,\psi}$
\State $x \gets \Call{transformAngVel2EulerRate}{x}$
\State $r \gets \Call{transformWorld2Orientation}{r,\psi}$
\State $u \gets K \cdot [x;e]$
\State $u.thrust\gets u.thrust + m \cdot g$
\State $u.yaw\gets r.yaw$
\State $e \gets e + Ts \cdot (r - x) $
\State \Return $u,e$
\EndProcedure

\State \textbf{main$()$}
\State $K\gets \Call{getLQRIController}{A,B,H,Q,R,Ts}$ 
\State $e,t,x\gets 0$
\While{running}
\State $r \gets \Call{getReferencePosition}{t}$
\State $u,e\gets \Call{callLQRIController}{x,r,e,K,\psi}$
\State $x,\psi\gets \Call{simulateMAV}{x,u,Ts}$
\State $t\gets t+Ts$
\EndWhile
\end{algorithmic}
\end{algorithm}