\chapter{Modeling}
\label{sec:modeling}
Multirotor flight position control essentially boils down to tilting the vehicle into the desired direction. Our position control therefore must find a reference attitude and thrust that makes the MAV move to the targeted positions. This reference attitude and thrust must be translated into reference motor rates by some attitude control. 

In this project we split these two tasks task by the means of a cascaded control approach (see figure \ref{pics:controller_sketch}). We will run the dynamically faster attitude and motor control at a high rate ($1000 \si{\hertz}$) in an inner loop and the high level position controller at $100 \si{\hertz}$ in an outer loop. 
\begin{figure}
\centering
\includegraphics{images/controller_sketch.tikz}
\caption{Cascaded control sketch}
\label{pics:controller_sketch}
\end{figure}

It simplifies the design of the position controller as only translational dynamics have to be considered explicitly and position control reduces to controlling the vehicles desired thrust and direction. 

In order for the vehicle to move to a reference position, the position controller computes the desired thrust force and roll, pitch, yaw angles. The inner loop then takes care of finding the appropriate moment applied to the vehicle body to archive the desired attitude. In this section the components from the control scheme in figure \ref{pics:controller_sketch} are modeled. 


First the multirotor platform is described. Then a compilation of models is derived to build the complete model. It starts with a detailed model on the equations of motion (section \ref{sec:eq_of_motion}), which explicitly contain the influence of motor drag. Next a model for wind and wind forces is proposed (section \ref{sec:wind_model}). In section \ref{sec:sys_id} the attitude dynamics are evaluated through system identification. Finally all these models are summarized into a set of overall dynamics which will describe our control system.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Platform
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Platform}
The AscTec Firefly (see figure \ref{pics:firefly}) is a hexacopter which is specifically designed for research purposes. While this is a hexacopter, the dynamics and controllers are generalized for any multirotor configuration. Here, a multirotor is a flying platform consisting of a body and a user specified arrangement of three or more rotors. Only configurations are considered which have all rotors lying fixed in a plane.

In platforms with even-numbered motors, neighboring rotors typically rotate in opposite direction. This compensates yaw moments and gives control over heading. Tilting is accomplished by increasing the thrust on on one side of the vehicle and decreasing it on the opposite side.

The Firefly has six $20 \si{\cm}$ diameter rotors equally aligned around the center. It is $60.5 \times 66.5 \times 16.5 \si{\cm}$ in size and weights $1.6 \si{\kg}$. The maximum thrust is $36 \si{\N}$ and it reaches a maximum airspeed of $15 \si{\metre\per\second}$.

\begin{figure}
   \centering
   \includegraphics[width=0.75\textwidth]{images/firefly.jpg}
   \caption{AscTec Firefly \cite{www:asctec}}
   \label{pics:firefly}
\end{figure}

It is provided with an inertial measurement unit (IMU) and has a efficient attitude controller onboard. In the experiment an external optical motion capture system by Vicon is used to feedback precise position information. A processor is taking care of online computation.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Equations of Motion
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Equations of Motion}
\label{sec:eq_of_motion}
The multirotor is modeled as a rigid body with six degrees of freedom (DoF). It has three translational DoF $x$, $y$, $z$ and three rotational DoF roll, pitch and yaw ($\phi$, $\theta$, $\psi$).

 For modeling purposes, we define proper reference frames and notations first. Then the dynamics acting at each rotor are stated. Next the Newton's and Euler's equations for the vehicle are formed giving the complete dynamics of the vehicle.

\subsection{Coordinate Systems and Notations}
\label{sec:coordinates}
\subsubsection{Coordinate Systems}
In total three main reference frames are defined. 
\begin{description}
\item[1. World-fixed frame] Cartesian coordinate system $\mathcal{W}$ with $x$, $y$, $z$ pointing east, north, up, and with the origin at the MAV's initial position.
\item[2. Orientation-fixed frame] Cartesian coordinate system $\mathcal{O}$ rotating world-fixed frame around the $z$-axis through the current heading of the MAV. 
\item[3. Body-fixed frame] Cartesian coordinate system $\mathcal{B}$ oriented along the multirotor's body axes $x$, $y$, $z$ pointing forward, sidewards left, upwards in direction of thrust, and having the origin at the center of gravity and body's principal axes of inertia.
\end{description}

\subsubsection{Notations}
We denote vectors and matrices with a bold letter. A trailing calligraphic subscript on a vector denotes the corresponding coordinate frame $\mathcal{W}$, $\mathcal{O}$ or $mathcal{B}$. 

In general, we will consider positions $\mathbf{r}$, velocities $\mathbf{v}$ and accelerations $\mathbf{a}$ in world-fixed coordinates, i.e.
\begin{align}
\mathbf{r} &= \begin{bmatrix}
x \\ y \\ z
\end{bmatrix},
& \mathbf{v} &= \begin{bmatrix}
\dot{x} \\ \dot{y} \\ \dot{z}
\end{bmatrix},
& \mathbf{a} &= \begin{bmatrix}
\ddot{x} \\ \ddot{y} \\ \ddot{z}
\end{bmatrix},
\end{align}
and omit the subscript. Rotational velocities $\boldsymbol{\omega}$ are considered in body-fixed coordinates.
\begin{align}
\boldsymbol{\omega} = \begin{bmatrix}
p \\ q \\ r
\end{bmatrix}
\end{align}

A calligraphic trailing double subscript on a matrix denotes the coordinate transformation from the second subscript frame to the first subscript frame. A single trailing subscript serves as additional descriptor. System matrices with a bar are denoted as the discrete time approximations, discretized about the position control sampling time $T_s = 0.01 \si{\second}$.

We abbreviate $\sin(\cdot)$ and $\cos(\cdot)$ with $s \cdot$ or $c \cdot$ respectively.

\subsubsection{Rotations}
For attitude representation we will use Euler angles $[\phi,~\theta,~\psi]$ following the $zyx$--sequence exclusively. The advantage of this representation is its simplicity and broad usage. However, it has three major disadvantages over unit quaternions. First, the proposed Euler angle sequence is prone to singularities at pitch angles $\theta = \frac{\pi}{2} + n\pi,~\forall~n\in\mathbb{Z}$. Second, they are less accurate when integrating incremental changes in attitude. Third, it is computational more expensive to evaluate trigonometric functions. Diebel provides a nice review on all sorts of transformations \cite{Diebel2006}. We will thus limit this report to introducing the necessary rotation matrices and assumptions made.

For a coordinate rotation about a single axis by an angle $\alpha$, we get the following rotation matrices from the special orthogonal group $SO(3)$:
\begin{align}
\mathbf{R}_x (\alpha)&=  \begin{bmatrix}
1 & 0 & 0 \\
0 & c\alpha & s\alpha \\
0 & -s\alpha & c\alpha
\end{bmatrix} ,\\
\mathbf{R}_y (\alpha)&=  \begin{bmatrix}
c\alpha & 0 & -s\alpha \\
0 & 1 & 0 \\
s\alpha & 0 & c\alpha
\end{bmatrix} ,\\
\mathbf{R}_z (\alpha)&=  \begin{bmatrix}
c\alpha & s\alpha & 0 \\
-s\alpha & c\alpha & 0 \\
0 & 0 &1
\end{bmatrix}.
\end{align}

The coordinate transformation from world-fixed frame $\mathcal{W}$ to orientation-fixed frame $\mathcal{O}$ is obtained by rotating the initial frame about the $z$--axis by the current heading $\psi$.
\begin{align}
\rotOW(\psi) = \mathbf{R}_z (\psi)
\end{align} 
The backwards transformation is achieved by transposition.
\begin{align}
\rotWO(\psi) = \rotOW^{-1}(\psi) = \rotOW^{T}(\psi)
\end{align}

Similar, the direction cosine matrix for the transformation from world-fixed frame $\mathcal{W}$ to body-fixed frame $\mathcal{B}$ is obtained. Following $xyz$--convention, we get
\begin{align}
\rotBW(\phi,\theta,\psi) &= {\mathbf{R}_x} (\phi) \cdot {\mathbf{R}_y} (\theta) \cdot {\mathbf{R}_z} (\psi) \\
&=
 \begin{bmatrix}
c\theta c\psi 				&c\theta s\psi 				& -s\theta  \\
s\phi s\theta c\psi - c\phi s\psi  	& s\phi s\theta s\psi + c\phi c\psi 	& s\phi c\theta \\
c\phi s\theta c\psi + s\phi s\psi	& c\phi s\theta s\psi - s\phi c\psi 	& c\phi c\theta
\end{bmatrix} ,\\
%
%
\rotWB (\phi,\theta,\psi) &= {\rotBW^{-1} (\phi,\theta,\psi)} = {\rotBW^{T} (\phi,\theta,\psi)} \\
&=
\begin{bmatrix}
c\theta c\psi & s\phi s\theta c\psi - c\phi s\psi & c\phi s\theta c\psi + s\phi s\psi \\
c\theta s\psi & s\phi s\theta s\psi + c\phi c\psi & c\phi s\theta s\psi - s\phi c\psi \\
-s\theta & s\phi c\theta & c\phi c\theta
\end{bmatrix}.
\end{align}

Finally, rotations from the orientation-fixed frame $\mathcal{O}$ to the body fixed frame $\mathcal{B}$ and reverse are
\begin{align}
\rotBO (\phi,\theta) &= {\mathbf{R}_x} (\phi) \cdot {\mathbf{R}_y} (\theta)  ,\\
\rotOB (\phi,\theta) &= {\rotBO^{-1} (\phi,\theta)} = {\rotBO^{T} (\phi,\theta)}.
\end{align}

In general, we will omit the attitude arguments in the rotation matrices.

\subsubsection{Connection Rotation Rates and Euler Rates}
To convert measured body rotation rates $\boldsymbol{\omega}$ into Euler angle rates we use the conjugate Euler angle rate matrix $\mathbf{E}_{xyz}'$.
\begin{align}
\begin{bmatrix}
\dot{\phi} \\ \dot{\theta} \\ \dot{\psi}
\end{bmatrix}
= [\mathbf{E}_{xyz}'(\phi,\theta,\psi)]^{-1} \cdot \boldsymbol{\omega} 
= \frac{1}{c\theta} \begin{bmatrix}
c\theta & s\phi s\theta & c\phi s\theta \\
0 & c\phi c\theta & -s\phi c\theta \\
0 & s\phi & c\phi
\end{bmatrix} \cdot \begin{bmatrix}
p \\ q \\ r
\end{bmatrix}
\end{align}

\subsection{Dynamics}
\label{sec:dynamics}
Martin et al. \cite{Martin2010} propose that the dominant forces and moments acting on a regular multirotor origin from the summation of the aerodynamic effects at each rotor and the gravitational force. We state the rotor dynamics with equations \ref{eq:rotor_begin} to \ref{eq:rotor_begin} which eventually lead to the Newton's equation \ref{eq:newton} and Euler's equation \ref{eq:euler} which completely describe the vehicle equations of motion. We do not model motor dynamics as they are much faster than the translational dynamics.

\subsubsection{Rotor Dynamics}
Blade theory gives the mechanics of each propeller/motor assembly. We neglect 
\begin{itemize} 
\item blade flapping (stiff rotors),
\item high order linear and angular velocity terms (small at hovering compared to blade tip speed),
\item linear and angular acceleration of propellers (low mass),
\item angular acceleration of motors (small at hovering),
\item friction torque due to rotational motion.
\end{itemize}

The remaining major forces are thrust $F_T$ and drag $F_D$. Thrust acts perpendicular to the blade plane and lifts the body. Drag acts opposing to the vehicle's airspeed and slows down the vehicle. The major torques acting on a single blade are roll moments $M_R$ and drag moments $M_D$. The direction of these moments and forces are depicted in figure. 

\begin{align}
\mathbf{F}_T&= \omega^2 \cdot C_T \cdot \mathbf{e}_{\mathcal{B},z}  &\text{(thrust)} ,\label{eq:rotor_begin} \\
\mathbf{F}_D&= -\omega \cdot  C_D \cdot \body{\mathbf{\boldsymbol{\nu}}^\perp} &\text{(drag)} , \label{eq:drag_force}\\
\mathbf{M}_R&= \omega \cdot C_R \cdot \body{\mathbf{\boldsymbol{\nu}}^\perp} &\text{(roll)} , \\
\mathbf{M}_D&= -\epsilon \cdot C_M \cdot \mathbf{F_T}  &\text{(drag)}, \label{eq:rotor_end}
\end{align}
where
\begin{align*}
\omega &: &\text{angular velocity of rotor blade}, \\
C_T>0 &: &\text{thrust constant}, \\
C_D>0 &: &\text{drag constant}, \\
C_R>0 &: &\text{rolling moment constant}, \\
C_M>0 &: &\text{drag moment constant}, \\
\epsilon\in\{-1,1\} &: &\text{turning direction (clockwise, counter clockwise)}, \\
\mathbf{e}_{\mathcal{B},z} &: &\text{unit vector in z-direction in base coordinates},\\
\body{\mathbf{\boldsymbol{\nu}}} &: &\text{airspeed in base coordinates} .
\end{align*}

The $\perp$-symbol denotes the projection of the air speed on the propeller plane (see figure). It can be calculated as:

\begin{align}
\body{\mathbf{\boldsymbol{\nu}}^\perp} &= \mathbf{e}_{\mathcal{B},z} \times \left( \body{\mathbf{\boldsymbol{\nu}}} \times \mathbf{e}_{\mathcal{B},z} \right) = \body{\mathbf{\boldsymbol{\nu}}} - \left( \body{\mathbf{\boldsymbol{\nu}}} \cdot \mathbf{e}_{\mathcal{B},z} \right) \cdot \mathbf{e}_{\mathcal{B},z}
=\begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 0
\end{bmatrix} {\body{\mathbf{\boldsymbol{\nu}}}} \label{eq:projection}.
\end{align}

\subsubsection{Newton's Equations}
The acceleration $\mathbf{a}$ in world frame can be found using Newton's second law. The sum of all forces equals to the body mass $m$ multiplied with the body acceleration. The forces are the $n$ thrust and drag forces and the gravitational force $\mathbf{F}_G$ 
\begin{align}
\mathbf{F} = m \cdot \mathbf{a} = \rotWB \sum_{i=1}^n \underbrace{\left(\mathbf{F}_{T,i} + \mathbf{F}_{D,i} \right)}_{=:\mathbf{F}_i} + \mathbf{F}_G \label{eq:newton}
\end{align}

\subsubsection{Euler's Equations}
The torque $\boldsymbol{\tau}$ acting on vehicle body's CoG can be found using Euler's equations for rigid body dynamics.
\begin{align}
\boldsymbol{\tau} = \mathbf{J} \cdot  \mathbf{\dot{\boldsymbol{\omega}}} + \boldsymbol{\omega} \times \mathbf{J} \cdot \boldsymbol{\omega} = \sum_{i=1}^n \left( \mathbf{M}_{R,i}+ \mathbf{M}_{D,i} + \mathbf{F}_i \times \mathbf{l}_i \right)  \label{eq:euler}
\end{align}
$\mathbf{J}$  is the inertia matrix referenced to the center of mass along the base-fixed frame. $\mathbf{l}_i$ denotes the vector from the CoG of the MAV to the $i$-th rotor about the base-fixed frame. $\boldsymbol{\omega}$ is the angular velocity about the same frame. 

For small tilt angles, the body angular velocity is approximately equal to the change in Euler angles.
\begin{align}
\boldsymbol{\omega} = \begin{bmatrix}
p \\ q \\ r
\end{bmatrix} = \begin{bmatrix}
1 & 0 & -s\theta \\
0 & c\theta & s\phi c\theta \\
0 & -s\phi & c\phi c\theta
\end{bmatrix} \begin{bmatrix}
\dot\phi \\ \dot\theta \\ \dot\psi
\end{bmatrix} \approx \begin{bmatrix}
\dot\phi \\ \dot\theta \\ \dot\psi
\end{bmatrix}
\end{align}


The moment equations are dispensible though, because attitude control is taken care of by an implemented controller already and its closed loop dynamics will be black box identified below. We still write them down for completeness.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Wind effects
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Wind Model}
\label{sec:wind_model}
In general wind is neither steady nor constant. Both azimuth and speed tend to jump instantaneously. Especially these wind gusts can deflect the MAV dangerously.

Having stated the equations of motion, it is possible to incorporate the effects of wind into the dynamics. This can help improve the controller performance in the case of a wind gust. If the wind is measured or known, the controller can feedforward the effects.

\subsection{Wind Dynamics}
Gust is usually defined as a increase of wind velocity $||\mathbf{w}||_2$ by $5\si{\metre\per\second}$ over the $10$-minute average wind velocity and has to have a duration of $3 \si{\second}$ to $20 \si{\second}$.

Figure \ref{fig:wind_observations} shows a typical wind observation. It shows wind speed and azimuth data measured in an open field over a whole day. The wind speed is showing random deviation around some time-varying average. In the morning hours, when the wind takes off, sudden changes in speed and azimuth occur. To identify this short time wind behavior the data has been zoomed in. From top to bottom graph the time intervals marked by the vertical grey boxes are magnified.

\begin{figure}
\centering
\subfloat[][{$24\si{\hour}$ wind speed $[ \si{\metre\per\second} ]$ observation }]{
\input{images/windday.tex}
\label{fig:wind_speed_day}}
\subfloat[][{$24\si{\hour}$ wind azimuth $[ \si{\degree} ]$ observation}]{
\input{images/windaziday.tex}
\label{fig:wind_azi_day}}
\qquad
\subfloat[][{Wind speeds $[ \si{\metre\per\second} ]$ from \formattime{5}{0}{0} to \formattime{6}{0}{0} }]{
\input{images/windhour.tex}
\label{fig:wind_speed_hour}}
\subfloat[][{Wind azimuth $[ \si{\degree} ]$ from \formattime{5}{0}{0} to \formattime{6}{0}{0} }]{
\input{images/windazihour.tex}
\label{fig:wind_azi_hour}}
\qquad
\subfloat[][{Wind speed $[ \si{\metre\per\second} ]$ from \formattime{5}{30}{0} to \formattime{5}{33}{0}  }]{
\input{images/windminute.tex}
\label{fig:wind_speed_minutes}}
\subfloat[][{Wind azimuth $[ \si{\degree} ]$ from \formattime{5}{30}{0} to \formattime{5}{33}{0}  }]{
\input{images/windaziminute.tex}
\label{fig:wind_azi_minutes}}
\caption[Wind observations]{Wind observations. The data is gathered using an anemometer $2.76 \si{\metre}$ above ground in an open field in California, USA. More information and measurement data can be found in Google's open source data collection \cite{www:googleosb,www:googleheliostat}.}
\label{fig:wind_observations}
\end{figure}

In the bottom picture \subref{fig:wind_speed_minutes} one can detect a wind gust at \formattime{5}{32}{0}. The wind velocity suddenly reaches a peak of $10 \si{\metre\per\second}$ after averaging around $5 \si{\metre\per\second}$. 

The MAV position control action takes place in an even smaller time interval. For visualization a $3 \si{\second}$ interval has been highlighted with a vertical grey line in figure \ref{fig:wind_observations} \subref{fig:wind_speed_minutes} and \subref{fig:wind_azi_minutes}. 

Within this small time window the wind field can be modeled as a stationary stochastic process. The wind speed vector is characterised by a constant mean and variance.

\begin{align}
\E[\mathbf{w}(t)] &= \mean{\mathbf{w}} \\
\Var[\mathbf{w}(t)] &= \E\left[\left(\mathbf{w}(t)-\mean{\mathbf{w}} \right) \left(\mathbf{w}(t)-\mean{\mathbf{w}} \right)^T \right]  =\mathbf{ \Sigma }
\end{align}

Thus the differential equation governing the wind field is
\begin{align}
\d{\mathbf{w}(t)} &= \mathbf{ \Sigma } \d{\mathbf{W}(t)} \label{eq:dwind} \\
\mathbf{w}(0) &= \mean{\mathbf{w}} \label{eq:dwind_init}
\end{align}
where $\mathbf{W}(t)$ is standard Brownian motion.

A more convenient way is to state the dynamics as a discrete-time state space systems.
\begin{align}
\mathbf{w}(k+1) &= \mathbf{w}(k) + \mathbf{\discrete{\Sigma}} \boldsymbol{\varepsilon}(k) \\ 
{\varepsilon}_i (k) &\sim \mathcal{N}(0,1) & \forall i \in \{ x,y,z \}
\label{eq:wind_state_space}
\end{align}


\subsection{Wind Forces}
Wind affects the MAV dynamics in two ways. On one hand it causes pressure on the multirotor surface opposed to the wind field. We call this load area drag $\mathbf{F}_A$. On the other hand the wind field influences the total rotor drag. We name this load drag force $\mathbf{F}_D$.

Schiano and others examined the effects of area drag on a Parrot AR Drone 2.0 (quadrotor) without polystyrene casing \cite{Schiano2014,www:parrot}. This MAV is a little smaller than the AscTec Firefly but the results are qualitatively comparable. They described area drag according to Rayleigh equations.

\begin{align}
\mathbf{F}_A = \frac{1}{2} C_A \rho \norm{\mathbf{w}}_2 \mathbf{w}  \label{eq:area_drag}
\end{align}
with
\begin{align*}
C_A&: & \text{area drag coefficient} \\
\rho&: &\text{air density} \\
\mathbf{w}&: &\text{wind speed in world coordinates}.
\end{align*}

In wind tunnel experiments they measured the forces on the switched off MAV for different angles of attack. They concluded that the drag coefficient is mainly a function of heading towards the wind. The worst case (largest force) equaled to $\psi = 90 \si{\degree}$, when the processor housing is exposed with the long side and thus the largest area towards the wind. 

Following rotor blade theory, the drag force is given as in equation \ref{eq:drag_force}.
\begin{align}
\mathbf{F}_W&= \sum_{i=1}^6 \omega_i \cdot  C_D \cdot _B\mathbf{\mathbf{w}}^\perp
\end{align}

Using the worst case area drag coefficient $C_A = 0.02$ from Schianos experiments and the rotor drag coefficent $C_D = \num{6.84 e-5}$ for the Firefly, we simulate the resulting forces. Figure \ref{fig:area_vs_rotor_drag} shows the area and the rotor drag at different wind speeds and a hovering Firefly.    

\begin{figure} 
\centering 
\input{images/area_vs_rotor_drag.tikz} 
\caption{Comparison of area and rotor drag at different wind velocities} 
\label{fig:area_vs_rotor_drag} 
\end{figure}

For small air speeds $\norm{\mathbf{w}}_2 \leq 5 \si{\metre\per\second}$ at which the MAV usually operates the rotor drag force is at least five times larger as the area drag. As a result, area drag will be neglected and only rotor drag due to wind will be modeled.

To incorporate wind explicitly into the Newton's equations \ref{eq:newton}, the air speed $\body{\boldsymbol{\nu}}$ is defined as the difference between vehicle speed $\mathbf{v}$ and wind speed $\mathbf{w}$ transformed to body coordinates.
\begin{align}
\body{\boldsymbol{\nu}} =\rotBW \left( {\mathbf{v}} - {\mathbf{w}} \right) 
\end{align}
According to the rotor drag equation \ref{eq:drag_force} and the projection \ref{eq:projection}, the total drag force in world coordinates acting on the multirotor is then
\begin{align}
\mathbf{F}_{D,total} & = \rotWB \sum_{i=1}^n \mathbf{F}_{D,i} \\ &=  - \sum_{i=1}^n \omega_i \cdot C_D \cdot \rotWB \cdot \begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 0
\end{bmatrix}
\cdot \rotBW \left( {\mathbf{v}} - {\mathbf{w}} \right). \label{eq:total_drag}
\end{align}

%\subsubsection{Remarks on sum of rotor rates}
%The sum of rotor rates denoted in the total drag force in equation \ref{eq:total_drag} is a time varying component in our system model and should be modeled as a state.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% System Identification
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{System Identification}
\label{sec:sys_id}
Instead of modeling the attitude controller, motor response and attitude dynamics we consider them as a black box. We approximate the attitude and thrust response of the MAV with a linear system.

\begin{equation}
\mathbf{y}(s) = \mathbf{G}(s) \mathbf{u}(s)
\end{equation}

To do this, we excite the real system with control inputs $\mathbf{u}(s)$ consisting of desired thrust $T_{ref}$, roll $\phi_{ref}$, pitch $\theta_{ref}$ and yaw $\psi_{ref}$ and measure its attained values $\mathbf{y}(s)$.

Figure \ref{pics:sys_id_model} shows a schematic model of the system. Given the control input, the attitude controller calculates a desired torque $\boldsymbol{\tau}_{ref}$. The desired motor speeds $\mathbf{n}_{ref}$ are then determined using a allocation map. These reference speeds are forwarded to the motor and the actual motor speeds affect the MAV's attitude.

\begin{figure}
\centering
\includegraphics{images/sys_id_model.tikz}
\caption{Schematic model $\mathbf{y}(s) = \mathbf{G}(s) \mathbf{u}(s)$ of black box to be identified.}
\label{pics:sys_id_model}
\end{figure}

From the experiment data the system $\mathbf{G}(s)$ is identified using MATLAB's transfer function estimation \texttt{tfest}. The method uses prediction error minimization (PEM).

The identification has to be done both for the MATLAB simulation environment and the real system.

\subsection{MATLAB Simulator}
\label{sec:matlab_simulator}
MATLAB is a good platform for prototyping control algorithms. It is easy to program and has helpful toolboxes and interfaces. We use it to simulate the non-linear inner loop dynamics depicted in figure \ref{pics:sys_id_model}.

The attitude is controlled by a geometric controller proposed by Lee \cite{Lee2010}. The allocation from desired thrust and torque to desired rotor rates is done by solving equation \ref{eq:allocation} in a least squares manner for the rotor rates. The matrix $\mathbf{A} \in \mathbb{R}^{4\times n}$ is called allocation matrix.
\begin{align}
\begin{bmatrix}
T_{ref} \\ \boldsymbol{\tau}_{ref}
\end{bmatrix} = \mathbf{A} \cdot \begin{bmatrix}
\omega_0^2 \\ \omega_1^2 \\ \vdots \\ \omega_{n-1}^2
\end{bmatrix} \label{eq:allocation} 
\end{align}
For a hexacopter with equally aligned rotors we have
\begin{align}
\mathbf{A} = \begin{bmatrix}
C_T & C_T & C_T & C_T & C_T & C_T \\
s\frac{\pi}{6} l C_T &   l C_T &  s\frac{\pi}{6} l C_T & -s\frac{\pi}{6} l C_T & -l C_T & -s\frac{\pi}{6} l C_T \\
-c\frac{\pi}{6} l C_T &  0 & c\frac{\pi}{6} l C_T &  c\frac{\pi}{6} l C_T &  0 & -c\frac{\pi}{6} l C_T \\
-C_T C_M &  C_T C_M &  -C_T C_M &   C_T C_M & -C_T C_M &  C_T C_M
\end{bmatrix}.
\end{align}
This matrix can be derived by expanding the equations of motion \ref{eq:newton} and \ref{eq:euler} and finding the corresponding thrust and torque in dependence of the squared rotor rates.

The closed loop motor dynamics are modeled as first order systems with a smaller time constant for acceleration than deceleration. Also they are limited by lower and upper bounds.
\begin{align}
\ddt \omega_i(t) =  \begin{cases}
-\frac{1}{80} \omega_i(t) + \frac{1}{80} \omega_{i,ref}(t) &\omega_{i,ref}(t) > \omega_i(t) \wedge \omega_i(t)<\omega_{max} ,\\
-\frac{1}{40} \omega_i(t) + \frac{1}{40} \omega_{i,ref}(t) &\omega_{i,ref}(t) \leq \omega_i(t)  \wedge \omega_i(t)>\omega_{min} ,\\
0  & \left( \omega_i(t)\leq \omega_{min} \wedge \omega_{i,ref}(t) \leq \omega_i(t) \right) \vee \\
& \left( \omega_i(t)\geq \omega_{max} \wedge \omega_{i,ref}(t) \geq \omega_i(t) \right).
\end{cases} \label{eq:motor_model}
\end{align}

The MAV dynamics are modeled according to the dynamics section \ref{sec:dynamics}. They include rotor drag and rolling moments.

\subsubsection{Simulated experiments}
We assume that the roll, pitch, yaw and thrust dynamics are independent from each other. The transfer function matrix $\mathbf{G}(s)$ is diagonal and we can run independent experiments for all four input/output combinations.

\begin{align}
\begin{bmatrix}
T \\ \phi \\ \theta \\ \psi
\end{bmatrix}
=
\begin{bmatrix}
G_{T_{ref} \rightarrow T} & 0 & 0 & 0 \\ 
0 & G_{\phi_{ref} \rightarrow \phi} & 0 & 0 \\ 
0 & 0 & G_{\theta_{ref} \rightarrow \theta} & 0 \\ 
0 & 0 & 0 & G_{\psi_{ref} \rightarrow \psi}  
\end{bmatrix}
\cdot
\begin{bmatrix}
T_{ref} \\ \phi_{ref} \\ \theta_{ref} \\ \psi_{ref}
\end{bmatrix}
\end{align}

Following Lennard Ljung on input design for open loop experiments \cite{ljung1999system} we generate a pseudo-random binary sequence (PRBS). This is a signal that alternates randomly between the maximum and minimum input value with a certain periodicity. It has an optimal crest factor, zero mean, and covers most frequencies. 

For all except the heading experiments, we pick a PRBS order of $n=8$, with a period length $M = 2^n-1 = 255$ which gives a sufficient resolution. $N = 10$ period repetitions are acceptable, regarding the experiment duration and coherency. For the heading experiment the PRBS order is increased to $n=12$ (period length $M=4095$) with only $N =4$ repitions, because the yaw dynamics are slower and this gives a stronger output signal.

As an example, figure \ref{fig:sys_id_phi_input} shows the roll experiment data. The amplitude levels have been chosen as
\begin{align}
T_{ref} &\in \{T_{min},T_{max}\} \\
\phi_{ref} &\in \{-22.5\si{\degree},22.5\si{\degree}\} \\
\theta_{ref} &\in \{-22.5\si{\degree},22.5\si{\degree}\} \\
\psi_{ref} &\in \{-90\si{\degree},90\si{\degree}\}
\end{align}
with
\begin{align}
T_{min} &= n \cdot \omega_{min}^2 \cdot C_T =  \num{9.2e-4} \si{\newton} , \label{eq:T_min}\\
T_{max} &= n \cdot \omega_{max}^2 \cdot C_T =  \num{36.8}\si{\newton} .\label{eq:T_max}\\
\end{align}
The first period has been dismissed to remove transients and the data detrended.

\begin{figure}
\centering
\subfloat[][{Output $\phi$}]{
\input{images/sys_id_phi_output.tikz}
\label{fig:sys_id_phi_output}}
\qquad
\subfloat[][{PRBS input $\phi_{ref}$}]{
\input{images/sys_id_phi_input.tikz}
\label{fig:sys_id_phi_input}}
\caption[Simulated system identification experiment]{Simulated system identification experiment for the roll transfer function from the input $\phi_{ref}$ to the output $\phi$.}
\label{fig:sys_id_phi}
\end{figure}

\subsubsection{Resulting Transfer Functions}
Evaluating the experiments the four transfer functions functions for thrust, roll, pitch and yaw have been found.

\subsubsection{Thrust Dynamics}
The thrust response $G_{T_{ref} \rightarrow T}$ has been identified as a first order system (equation \ref{eq:tf_T}). The time constant of the system ($0.016 \si{\second}$) lies in between the motor up and down time constants ($0.0125 \si{\second} / 0.025 \si{\second}$) specified by the nonlinear motor system in equation \ref{eq:motor_model}.
\begin{align}
G_{T_{ref} \rightarrow T}(s) &= \frac{41}{s+62} \label{eq:tf_T}
\end{align}
This is identical to the state space representation
\begin{align}
\ddt T(t) &= \mathbf{A}_T T(t) + \mathbf{B}_T T_{ref}(t) \\
\mathbf{A}_T &= -62	\\
\mathbf{B}_T &=41
\end{align}

\subsubsection{Roll Dynamics}
The roll transfer function $G_{\phi_{ref} \rightarrow \phi}$ has been identified as a second-order system:
\begin{align}
G_{\phi_{ref} \rightarrow \phi}(s) &= \frac{77.26}{s^2+12.99s+81.36}  \label{eq:tf_phi}
\end{align}
An observable canonical state space representation of this transfer function is
\begin{align}
\ddt \begin{bmatrix}
\frac{1}{8}\dot{\phi}(t) \\ \phi(t)
\end{bmatrix}
&= \mathbf{A}_\phi \begin{bmatrix}
\frac{1}{8}\dot{\phi}(t) \\ \phi(t)
\end{bmatrix}
+ \mathbf{B}_\phi \phi_{ref}(t) \\
y(t) &= \phi(t) \\
\mathbf{A}_\phi &= \begin{bmatrix}
-12.98 & -10.17 \\
8 & 0
\end{bmatrix} \\
\mathbf{B}_\phi &= \begin{bmatrix}
9.66 \\ 0
\end{bmatrix}
\end{align}

\subsubsection{Pitch Dynamics}
The pitch transfer function $G_{\theta_{ref} \rightarrow \theta}$ has been identified as a second-order system:
\begin{align}
G_{\theta_{ref} \rightarrow \theta}(s) &= \frac{61.47}{s^2+10.88s+65.93}  \label{eq:tf_theta}
\end{align}
They are a little bit slower than the roll dynamics. An observable canonical state space representation of this transfer function is
\begin{align}
\ddt \begin{bmatrix}
\frac{1}{8}\dot{\theta}(t) \\ \theta(t)
\end{bmatrix}
&= \mathbf{A}_\theta \begin{bmatrix}
\frac{1}{8}\dot{\theta}(t) \\ \theta(t)
\end{bmatrix}
+ \mathbf{B}_\theta \theta_{ref}(t) \\
y(t) &= \theta(t) \\
\mathbf{A}_\theta &= \begin{bmatrix}
-10.95 & -8.25 \\
8 & 0
\end{bmatrix} \\
\mathbf{B}_\theta &= \begin{bmatrix}
7.69 \\ 0
\end{bmatrix}
\end{align}

\subsubsection{Yaw Dynamics}
The yaw transfer function $G_{\psi_{ref} \rightarrow \psi}$ has been identified as a second-order system:
\begin{align}
G_{\psi_{ref} \rightarrow \psi}(s) &= \frac{1}{s}\frac{0.81}{4s+1}  \label{eq:tf_psi}
\end{align}
This system is a lot slower than the roll and pitch dynamics. An observable canonical state space representation of this transfer function is
\begin{align}
\ddt \begin{bmatrix}
\dot{\psi}(t) \\ \psi(t)
\end{bmatrix}
&= \mathbf{A}_\psi \begin{bmatrix}
\dot{\psi}(t) \\ \psi(t)
\end{bmatrix}
+ \mathbf{B}_\psi \psi_{ref}(t) \\
y(t) &= \psi(t) \\
\mathbf{A}_\psi &= \begin{bmatrix}
-0.25 & 0 \\
1 & 0
\end{bmatrix} \\
\mathbf{B}_\psi &= \begin{bmatrix}
0.2 \\ 0
\end{bmatrix}
\end{align}

\subsubsection{Conclusion}
The thrust dynamics \ref{eq:tf_T} are much faster than any other dynamics in the whole system. Thus we can dismiss the first order system \ref{eq:tf_T} and instead model
\begin{align}
T(t) = T_{ref}(t). \label{eq:tf_T_fast}
\end{align}

The roll and pitch dynamics remain modeled as in \ref{eq:tf_phi} and \ref{eq:tf_theta}.

The yaw dynamics have been identified as a lot slower than the roll and pitch dynamics. In our control algorithms we will model them constant with the current measurement $\psi_m(t_0)$ as initialization.
\begin{align}
\ddt \psi(t) &= 0 \label{eq:const_yaw} \\ 
\psi(t_0) &= \psi_m(t_0) 
\end{align}

These models will be used in prototyping the controller.

\subsection{Real System}
The real system differs from the simulated one. It has a different attitude controller, and follows the real dynamics. In the real system we will also neglect the thrust dynamics, model roll and pitch as second-order systems and consider yaw as constant. However, we can not run a PRBS experiment as in the simulated MAV.

Instead we use the recorded experiment visualized in figure \ref{fig:sys_id_real_exp}. In this experiment the Firefly has been flying aggressive maneuvers indoors. The measurements have been taken from a Vicon motion capturing system and the integrated IMU.
\begin{figure} 
\centering 
\input{images/sys_id_real_exp.tikz} 
\caption{One minute system identification experiment with the real Firefly} 
\label{fig:sys_id_real_exp} 
\end{figure}

From this experiment the identified roll and pitch dynamics are
\begin{align}
G_{\phi_{ref} \rightarrow \phi}(s) &= \frac{87.17}{s^2+21.26s+116.8}  \label{eq:tf_phi_real} \\
G_{\theta_{ref} \rightarrow \theta}(s) &= \frac{62.69}{s^2+15.17s+95.38}  \label{eq:tf_theta_real}
\end{align}
Transforming these transfer functions into observical canonical state space representation gives the following system equations:

\begin{align}
\ddt \begin{bmatrix}
\frac{1}{8}\dot{\phi}(t) \\ \phi(t)
\end{bmatrix}
&= \mathbf{A}_\phi \begin{bmatrix}
\frac{1}{8}\dot{\phi}(t) \\ \phi(t)
\end{bmatrix}
+ \mathbf{B}_\phi \phi_{ref}(t) \\
y(t) &= \phi(t) \\
\mathbf{A}_\phi &= \begin{bmatrix}
-21.26 & -14.6 \\
8 & 0
\end{bmatrix} \\
\mathbf{B}_\phi &= \begin{bmatrix}
10.9 \\ 0
\end{bmatrix}\\
\ddt \begin{bmatrix}
\frac{1}{8}\dot{\theta}(t) \\ \theta(t)
\end{bmatrix}
&= \mathbf{A}_\theta \begin{bmatrix}
\frac{1}{8}\dot{\theta}(t) \\ \theta(t)
\end{bmatrix}
+ \mathbf{B}_\theta \theta_{ref}(t) \\
y(t) &= \theta(t) \\
\mathbf{A}_\theta &= \begin{bmatrix}
-15.17 & -11.92 \\
8 & 0
\end{bmatrix} \\
\mathbf{B}_\theta &= \begin{bmatrix}
7.836 \\ 0
\end{bmatrix}
\end{align}
Note that the real system is a little bit faster and has a considerable higher damping. Also the real system has a smaller gain. In figure \ref{fig:sys_id_step_response} one can compare the step responses of the two estimated roll transfer functions.

This difference can come from the fact that in simulation we ran a nearly optimal open loop experiment while the real experiment is closed loop, noisy and can not be excited with a PRBS input. Also the applied attitude controller varies and of course we don't have the real dynamics and parameters in the simulation.

Still both identifications show similar behavior in terms of system order and response time and thus the simulator seems valuable.
\begin{figure} 
\centering 
\input{images/sys_id_step_response.tikz} 
\caption{Step responses ($\phi_{ref} = 30 \si{\degree}$) of the identified roll dynamics for the simulated and the real experiment} 
\label{fig:sys_id_step_response} 
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% System Formulation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{System Formulation}
Having all necessary components modeled we can state the complete nonlinear model to be controlled. The translational dynamics are to be modeled by the motions of equations stated in the Newton's equations \ref{eq:newton}. The other dynamics, i.e. attitude control, allocation mapping and motor response are modeled as the black box model described in in the system identification section \ref{sec:sys_id}. The overall system is scratched in figure \ref{pics:control_system}.

\begin{figure}
\centering
\includegraphics{images/control_system.tikz}
\caption{Schematic model of the overall control system.}
\label{pics:control_system}
\end{figure}

Summarized, the following state-space system is governing the system.
\begin{align}
\mathbf{x} &= \begin{bmatrix}
\frac{1}{8} \dot{\phi} & \phi & \frac{1}{8} \dot{\theta} & \theta & x & y & z & \dot{x} & \dot{y} & \dot{z}
\end{bmatrix}^T & \text{(states)}  \label{eq:states}\\
\mathbf{u} &= \begin{bmatrix}
T_{ref} & \phi_{ref} & \theta_{ref} 
\end{bmatrix}^T & \text{(inputs)} \\
\mathbf{y} &= \mathbf{x} & \text{(outputs)} \\
\mathbf{w} &= \begin{bmatrix}
w_x & w_y & w_z
\end{bmatrix}^T & \text{(disturbances)} \\
f\left(\mathbf{x},\mathbf{u},\mathbf{w}\right) &= \ddt \mathbf{x}  
= \begin{bmatrix}
\mathbf{A}_\phi \begin{bmatrix}
\frac{1}{8}\dot{\phi}(t) \\ \phi(t)
\end{bmatrix}
+ \mathbf{B}_\phi \phi_{ref}(t) \\
\mathbf{A}_\theta \begin{bmatrix}
\frac{1}{8}\dot{\theta}(t) \\ \theta(t)
\end{bmatrix}
+ \mathbf{B}_\theta \theta_{ref}(t) \\
\dot{x} \\
\dot{y} \\
\dot{z} \\
\frac{1}{m} \left( \mathbf{F}_{T,total} + \mathbf{F}_{D,total} \right)  + \begin{bmatrix}
0 \\ 0 \\ -g
\end{bmatrix} 
\end{bmatrix} \label{eq:state_diff}\\
g \left( \mathbf{x},\mathbf{u} \right) &= \mathbf{x} \label{eq:measurement}
\end{align}
The total drag force $\mathbf{F}_{D,total}$ in world-fixed frame is a function of the rotor rates, the wind, the vehicle velocity, and the attitude and is written in equation \ref{eq:total_drag}. The total thrust $\mathbf{F}_{T,total}$ in world-fixed frame is a function of the desired thrust and the attitude.
\begin{align}
\mathbf{F}_{T,total} = \rotWB \cdot \sum_{i=1}^n \omega_i^2 \cdot C_T \cdot \mathbf{e}_{z,\mathcal{B}} = \rotWB \cdot \begin{bmatrix}
0 \\ 0 \\ T
\end{bmatrix}= \rotWB \cdot \begin{bmatrix}
0 \\ 0 \\ T_{ref}
\end{bmatrix}
\end{align}

\begin{remark}
As stated in the system identification section \ref{sec:sys_id} in equation \ref{eq:const_yaw}, we will consider the heading $\psi$ not as a state, but as a constant due to its slow dynamics. The controllers will set the reference heading equal the desired heading and use the currently measured heading as a parameter.
\begin{align}
\psi_{ref}(t) = \psi_{des}(t)
\end{align}
\end{remark}

\begin{remark}
The sum of all rotor rates ${\sum_{i=1}^n {\omega_i(t)}}$, which is entering the drag force \ref{eq:total_drag}, is actually dynamic. Especially with large changes in thrust it varies a lot. However, as most of a flight takes place around hovering and in the end the effect of drag is small, we approximate the rotor rates with the hovering rates $\bar{\omega}$.
\begin{align}
{\sum_{i=1}^n {\omega_i(t)}} = n \cdot \bar{\omega}
\end{align}
\end{remark}

\begin{remark}
Desiring a deterministic problem formulation, we consider the expected value of the current wind $\E[\mathbf{w}]$ instead of its stochastic process \ref{eq:dwind} -- \ref{eq:dwind_init}.
\end{remark}


\section{Linearized System}
As two linear controllers are proposed, the system \ref{eq:states} -- \ref{eq:measurement} has to be linearized. However, if the translational dynamics are linearized around hovering straight away, the heading $\psi$ will be part of the dynamics explicitly.

Instead, we will transform all translational states and disturbances into the orientation-fixed coordinate frame $\mathcal{A}$ described in \ref{sec:coordinates}. The state governing differential equations \ref{eq:state_diff} are adapted accordingly.

With the linearization all higher order terms are neglected. This includes the wind's $z$-component, which is why we can cross it from the disturbances.

\begin{align}
\orientation{\mathbf{x}} &= \begin{bmatrix}
\frac{1}{8} \dot{\phi} & \phi & \frac{1}{8} \dot{\theta} & \theta & \orientation{x} & \orientation{y} & \orientation{z} & \orientation{\dot{x}} & \orientation{\dot{y}} & \orientation{\dot{z}}
\end{bmatrix}^T \\
\orientation{\mathbf{u}} &= \begin{bmatrix}
T_{ref} & \phi_{ref} & \theta_{ref} 
\end{bmatrix}^T\\
\orientation{\mathbf{y}} &= \orientation{\mathbf{x}}\\
\orientation{\mathbf{w}} &= \begin{bmatrix}
w_{x,\mathcal{O}} & w_{y,\mathcal{O}} 
\end{bmatrix}^T \\
\orientation{f}\left(\orientation{\mathbf{x}},\orientation{\mathbf{u}},\orientation{\mathbf{w}}\right) &= \ddt \orientation{\mathbf{x}} \\
&=  \begin{bmatrix}
\mathbf{A}_\phi \begin{bmatrix}
\frac{1}{8}\dot{\phi}(t) \\ \phi(t)
\end{bmatrix}
+ \mathbf{B}_\phi \phi_{ref}(t) \\
\mathbf{A}_\theta \begin{bmatrix}
\frac{1}{8}\dot{\theta}(t) \\ \theta(t)
\end{bmatrix}
+ \mathbf{B}_\theta \theta_{ref}(t) \\
\orientation{\dot{x}} \\
\orientation{\dot{y}} \\
\orientation{\dot{z}} \\
\frac{1}{m} \left( \mathbf{F}_{T,total,\mathcal{O}} + \mathbf{F}_{D,total,\mathcal{O}} \right)  + \begin{bmatrix}
0 \\ 0 \\ -g
\end{bmatrix} 
\end{bmatrix}  \\
\orientation{g} \left( \orientation{\mathbf{x}},\orientation{\mathbf{u}} \right) &= \orientation{\mathbf{x}}
\end{align}
The states and disturbances are obtained by rotating them into the current heading direction.
\begin{align}
\orientation{\mathbf{r}} &= \rotOW \cdot \mathbf{r} \\
\orientation{\mathbf{v}} &= \rotOW \cdot \mathbf{v} \\
\orientation{\mathbf{w}} &= \rotOW \cdot \mathbf{w}
\end{align}
The total thrust force and drag force is manipulated such that it is in orientation-fixed coordinates.
\begin{align}
\mathbf{F}_{T,total,\mathcal{O}} &= \rotOB \cdot \sum_{i=1}^n \omega_i^2 \cdot C_T \cdot \mathbf{e}_{z,\mathcal{B}} = \rotOB \cdot \begin{bmatrix}
0 \\ 0 \\ T
\end{bmatrix}= \rotOB \cdot \begin{bmatrix}
0 \\ 0 \\ T_{ref}
\end{bmatrix} \\
\mathbf{F}_{D,total,\mathcal{O}} & = \rotOB \sum_{i=1}^n \mathbf{F}_{D,i,\mathcal{O}} \\ &=  - \sum_{i=1}^n \omega_i \cdot C_D \cdot \rotOB \cdot \begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 0
\end{bmatrix}
\cdot \rotBO \left( \orientation{\mathbf{v}} - \orientation{\mathbf{w}} \right)
\end{align}

The system above is now linearized around hovering by finding its partial derivatives with respect to the states, inputs and disturbances. This rather cumbersome task has been done using MATLAB's Symbolic Toolbox. With this toolbox you can create symbolic variables, perform algebraic operations, calculate jacobians and substitute values for the variables.
\begin{align}
\ddt \orientation{\mathbf{x}} &= 
\mathbf{A} \left( \orientation{\mathbf{x}} - \mathbf{x}_{\mathcal{O},ss} \right) + \mathbf{B} \left( \orientation{\mathbf{u}} - \mathbf{u}_{\mathcal{O},ss} \right) + \mathbf{B}_w \left( \orientation{\mathbf{w}} - \mathbf{w}_{\mathcal{O},ss} \right) \label{eq:lin_sys_dt}, \\
\mathbf{y} &= 
\mathbf{C} \left( \orientation{\mathbf{x}} - \mathbf{x}_{\mathcal{O},ss} \right) +  
\mathbf{D} \left( \orientation{\mathbf{u}} - \mathbf{u}_{\mathcal{O},ss} \right)  +  
\mathbf{D}_w \left( \orientation{\mathbf{w}} - \mathbf{w}_{\mathcal{O},ss} \right), \label{eq:lin_sys_y}
\end{align}
where
\begin{align}
\mathbf{A} &= \left.{\frac{\partial \orientation{f}}{\partial \orientation{\mathbf{x}}} \left( \orientation{\mathbf{x}},\orientation{\mathbf{u}}, \orientation{\mathbf{w}} \right) }\right|_{\mathbf{x}_{\mathcal{O},ss}, \mathbf{u}_{\mathcal{O},ss}, \mathbf{w}_{\mathcal{O},ss}}, \\
%%%%%
\mathbf{B} &= \left.{\frac{\partial \orientation{f}}{\partial \orientation{\mathbf{u}}} \left( \orientation{\mathbf{x}},\orientation{\mathbf{u}}, \orientation{\mathbf{w}} \right) }\right|_{\mathbf{x}_{\mathcal{O},ss}, \mathbf{u}_{\mathcal{O},ss}, \mathbf{w}_{\mathcal{O},ss}}, \\
%%%%%
\mathbf{B}_w &= \left.{\frac{\partial \orientation{f}}{\partial \orientation{\mathbf{w}}} \left( \orientation{\mathbf{x}},\orientation{\mathbf{u}}, \orientation{\mathbf{w}} \right) }\right|_{\mathbf{x}_{\mathcal{O},ss}, \mathbf{u}_{\mathcal{O},ss}, \mathbf{w}_{\mathcal{O},ss}}, \\
%%%%%
\mathbf{C} &= \left.{\frac{\partial \orientation{g}}{\partial \orientation{\mathbf{x}}} \left( \orientation{\mathbf{x}},\orientation{\mathbf{u}}, \orientation{\mathbf{w}} \right) }\right|_{\mathbf{x}_{\mathcal{O},ss}, \mathbf{u}_{\mathcal{O},ss}, \mathbf{w}_{\mathcal{O},ss}}, \\
%%%%%
\mathbf{D} &= \left.{\frac{\partial \orientation{g}}{\partial \orientation{\mathbf{u}}} \left( \orientation{\mathbf{x}},\orientation{\mathbf{u}}, \orientation{\mathbf{w}} \right) }\right|_{\mathbf{x}_{\mathcal{O},ss}, \mathbf{u}_{\mathcal{O},ss}, \mathbf{w}_{\mathcal{O},ss}}, \\
%%%%%
\mathbf{D}_w &= \left.{\frac{\partial \orientation{g}}{\partial \orientation{\mathbf{w}}} \left( \orientation{\mathbf{x}},\orientation{\mathbf{u}}, \orientation{\mathbf{w}} \right) }\right|_{\mathbf{x}_{\mathcal{O},ss}, \mathbf{u}_{\mathcal{O},ss}, \mathbf{w}_{\mathcal{O},ss}}, \\
\end{align}
and
\begin{align}
\mathbf{x}_{\mathcal{O},ss} &= \begin{bmatrix}
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0
\end{bmatrix} ,\\
\mathbf{u}_{\mathcal{O},ss} &= \begin{bmatrix}
m \cdot g & 0 & 0
\end{bmatrix} ,\\ 
\mathbf{w}_{\mathcal{O},ss} &= \begin{bmatrix}
0 & 0 
\end{bmatrix}.
\end{align}

Eventually we obtain the state matrix $\mathbf{A} \in \mathbb{R}^{10\times10}$, input matrix $\mathbf{B} \in \mathbb{R}^{10\times3}$, disturbance input matrix $\mathbf{B}_w \in \mathbb{R}^{10\times2}$, output matrix $\mathbf{C} \in \mathbb{R}^{10\times10}$,  feedthrough matrix $\mathbf{D} \in \mathbb{R}^{10\times3}$ and disturbance feedthrough matrix  $\mathbf{D}_w \in \mathbb{R}^{10\times2}$. 

\begin{align}
\mathbf{A} &= \begin{bmatrix}
\mathbf{A}_{\phi,11} & \mathbf{A}_{\phi,12} & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
\mathbf{A}_{\phi,21} & \mathbf{A}_{\phi,22} & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & \mathbf{A}_{\theta,11} & \mathbf{A}_{\theta,12} & 0 & 0 & 0 & 0 & 0 & 0  \\
0 & 0 & \mathbf{A}_{\theta,21} & \mathbf{A}_{\theta,22} & 0 & 0 & 0 & 0 & 0 & 0  \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 \\
0 & 0 & 0 & g & 0 & 0 & 0 & \frac{-C_D n \bar{\omega}}{m} & 0 & 0 \\
0 & -g & 0 & 0 & 0 & 0 & 0 & 0 & \frac{-C_D n \bar{\omega}}{m} & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 
\end{bmatrix} \label{eq:system_matrix}\\
\mathbf{B} &= \begin{bmatrix}
0 & \mathbf{B}_{\phi,11} & 0 \\
0 & \mathbf{B}_{\phi,21} & 0 \\
0 & 0 & \mathbf{B}_{\theta,11} \\
0 & 0 & \mathbf{B}_{\theta,21} \\
0 & 0 & 0 \\
0 & 0 & 0 \\
0 & 0 & 0 \\
0 & 0 & 0 \\
0 & 0 & 0 \\
\frac{1}{m} & 0 & 0
\end{bmatrix} \\
\mathbf{B}_W &= \begin{bmatrix}
0 & 0 \\
0 & 0 \\
0 & 0 \\
0 & 0 \\
0 & 0 \\
0 & 0 \\
0 & 0 \\
\frac{C_D n \bar{\omega}}{m} & 0 \\
0 & \frac{C_D n \bar{\omega}}{m} \\
0 & 0
\end{bmatrix} \\
\mathbf{C} &= \mathbf{I}_{10} \\
\mathbf{D} &= \mathbf{0}_{10\times3} \\
\mathbf{D}_W &= \mathbf{0}_{10\times2}
\end{align}

The system $(\mathbf{A},\mathbf{B})$ is controllable and the system $(\mathbf{A},\mathbf{C})$ is observable, as the whole state is measured. One can see clearly that the drag force is counteracting the acceleration in $x$ and $y$ direction and how the wind is entering the system via the translational dynamics. 

%In the following, when referring to the linearized system, we will omit the difference notation and instead only write the state or input variable. For example,
%\begin{align}
%\orientation{\mathbf{x}} - \mathbf{x}_{\mathcal{O},ss} = \orientation{\mathbf{x}}
%\end{align}